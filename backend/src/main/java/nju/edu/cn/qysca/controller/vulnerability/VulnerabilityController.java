package nju.edu.cn.qysca.controller.vulnerability;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import nju.edu.cn.qysca.controller.ResponseMsg;
import nju.edu.cn.qysca.domain.vulnerability.dos.CweDO;
import nju.edu.cn.qysca.domain.vulnerability.dtos.VulnerabilityBriefDTO;
import nju.edu.cn.qysca.domain.vulnerability.dtos.VulnerabilityDTO;
import nju.edu.cn.qysca.service.vulnerability.VulnerabilityService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

@Api(tags = "漏洞管理")
@RestController
@RequestMapping("qysca/vulnerability")
public class VulnerabilityController {

    @Autowired
    private VulnerabilityService vulnerabilityService;


    @ApiOperation("获取某个组件的漏洞列表")
    @GetMapping("/getComponentVulnerabilityList")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/getComponentVulnerabilityList')")
    public ResponseMsg<Page<VulnerabilityBriefDTO>> getComponentVulnerabilityList(@RequestParam String name, @RequestParam String version,@RequestParam String language, @RequestParam int page, @RequestParam int size){
        return new ResponseMsg<>(vulnerabilityService.getComponentVulnerabilityList(name, version, language, page, size));
    }

    @ApiOperation("获取某个应用的漏洞列表")
    @GetMapping("/getApplicationVulnerabilityList")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/getApplicationVulnerabilityList')")
    public ResponseMsg<Page<VulnerabilityBriefDTO>> getApplicationVulnerabilityList(@RequestParam String name, @RequestParam String version,@RequestParam int page, @RequestParam int size){
        return new ResponseMsg<>(vulnerabilityService.getApplicationVulnerabilityList(name, version, page, size));
    }

    @ApiOperation("在某个应用中增加漏洞信息")
    @PostMapping("/addAppVulnerability")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/addAppVulnerability')")
    public ResponseMsg<Boolean> addAppVulnerability(@RequestParam String name, @RequestParam String version, @RequestParam String cveId){
        return new ResponseMsg<>(vulnerabilityService.addAppVulnerability(name, version, cveId));
    }

    @ApiOperation("在某个应用中删除漏洞信息")
    @PostMapping("/deleteAppVulnerability")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/deleteAppVulnerability')")
    public ResponseMsg<Boolean> deleteAppVulnerability(@RequestParam String name, @RequestParam String version, @RequestParam String cveId){
        return new ResponseMsg<>(vulnerabilityService.deleteAppVulnerability(name, version, cveId));
    }

    @ApiOperation("查看某个漏洞的详细信息")
    @GetMapping("/getVulnerabilityById")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/getVulnerabilityById')")
    public ResponseMsg<VulnerabilityDTO> getVulnerabilityById(@RequestParam String cveId) {
        return new ResponseMsg<>(vulnerabilityService.findVulnerabilityById(cveId));
    }

    @ApiOperation("查看某个漏洞类型的详细信息")
    @GetMapping("/getCweById")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/getCweById')")
    public ResponseMsg<CweDO> getCweById(@RequestParam String cweId) {
        return new ResponseMsg<>(vulnerabilityService.findCweById(cweId));
    }

    @ApiOperation("查看漏洞库界面")
    @GetMapping("getVulnerabilityPage")
    @PreAuthorize("@my.checkAuth('/qysca/vulnerability/getVulnerabilityPage')")
    public ResponseMsg<Page<VulnerabilityBriefDTO>> getVulnerabilityPage(@RequestParam String cveId, @RequestParam int page, @RequestParam int size) {
        return new ResponseMsg<>(vulnerabilityService.searchVulnerability(cveId, page, size));
    }
}
