<template>
  <div class="main">
    <div class="title">漏洞管理</div>
    <a-card class="content_card">
      <div class="operations">
        <div>
          <a-input-search
            v-model:value="data.search.cveId"
            placeholder="请输入漏洞编号"
            style="width: 250px"
            @change="(e) => getVuls()"
            @search="(value, e) => getVuls()"></a-input-search>
        </div>
      </div>
      <a-spin :spinning="data.spinning" tip="漏洞信息加载中，请稍等...">
        <a-table :data-source="data.datasource" :columns="data.columns" bordered :pagination="pagination">
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'cveId'">
              <div class="column_name" @click="showInfo(record)">{{ record.cveId }}</div>
            </template>
            <template v-if="column.key === 'problemType'">
              <div>{{ arrToString(record.problemType) }}</div>
            </template>
            <template v-if="column.key === 'severity'">
              <a-tag v-if="record.severity === 'CRITICAL'" color="error">严重</a-tag>
              <a-tag v-if="record.severity === 'HIGH'" color="error">高危</a-tag>
              <a-tag v-if="record.severity === 'MEDIUM'" color="warning">中危</a-tag>
              <a-tag v-if="record.severity === 'LOW'" color="processing">低危</a-tag>
              <a-tag v-if="record.severity === 'NONE'" color="success">无危险</a-tag>
              <a-tag v-if="record.severity === 'UNKNOWN'">未知</a-tag>
            </template>
            <template v-if="column.key === 'attackType'">
              <div v-if="!record.attackType">-</div>
              <div v-if="record.attackType === 'NETWORK'">网络</div>
              <div v-if="record.attackType === 'ADJACENT_NETWORK'">邻接网络</div>
              <div v-if="record.attackType === 'LOCAL'">本地</div>
              <div v-if="record.attackType === 'PHYSICAL'">物理</div>
            </template>
            <template v-if="column.key === 'cvss3Score'">
              <div v-if="!record.cvss3Score">-</div>
              <div v-else>{{ record.cvss3Score }}</div>
            </template>
            <template v-if="column.key === 'cvss2Score'">
              <div v-if="!record.cvss2Score">-</div>
              <div v-else>{{ record.cvss2Score }}</div>
            </template>
            <template v-if="column.key === 'publishedDate'">
              <div>{{ formatDate(record.publishedDate) }}</div>
            </template>
            <template v-if="column.key === 'lastModifiedDate'">
              <div>{{ formatDate(record.lastModifiedDate) }}</div>
            </template>
            <template v-if="column.key === 'action'">
              <a-tooltip>
                <template #title>详情</template>
                <FileTextOutlined
                  :style="{ fontSize: '18px', color: '#6f005f', marginRight: '10px' }"
                  @click="showInfo(record)" />
              </a-tooltip>
            </template>
          </template>
          <template #emptyText>暂无数据</template>
        </a-table>
      </a-spin>
      <Drawer ref="drawer"></Drawer>
    </a-card>
  </div>
</template>

<script setup>
import { reactive, ref, onMounted } from 'vue'
import {
  PlusOutlined,
  FileTextOutlined,
  SyncOutlined,
  DeleteOutlined,
  RollbackOutlined,
  LoadingOutlined,
  ExclamationCircleOutlined,
  CheckOutlined,
  CloseOutlined
} from '@ant-design/icons-vue'
import { GetAllVul } from '@/api/frontend'
import Drawer from '@/components/VulnerabilityDrawer.vue'
import { message } from 'ant-design-vue'
import { arrToString, formatDate } from '@/utils/util.js'

onMounted(() => {
  getVuls()
})
const drawer = ref()

const data = reactive({
  accurate: false,
  spinning: false,
  search: {
    cveId: ''
  },
  datasource: [],
  columns: [
    { title: '漏洞编号', dataIndex: 'cveId', key: 'cveId', width: 150 },
    { title: '严重程度', dataIndex: 'severity', key: 'severity', width: 90 },
    { title: '漏洞类型', dataIndex: 'problemType', key: 'problemType', width: 90 },
    { title: '攻击类型', dataIndex: 'attackType', key: 'attackType', width: 90 },
    { title: 'cvss3评分', dataIndex: 'cvss3Score', key: 'cvss3Score', width: 100 },
    { title: 'cvss2评分', dataIndex: 'cvss2Score', key: 'cvss2Score', width: 100 },
    { title: '漏洞委托方', dataIndex: 'cveAssigner', key: 'cveAssigner' },
    { title: '发布时间', dataIndex: 'publishedDate', key: 'publishedDate' },
    { title: '最后修改时间', dataIndex: 'lastModifiedDate', key: 'lastModifiedDate' },
    { title: '操作', dataIndex: 'action', key: 'action', width: 60 }
  ]
})
const pagination = reactive({
  current: 1,
  total: 0,
  pageSize: 10,
  showSizeChanger: false,
  onChange: (page, size) => {
    pagination.current = page
    getVuls(page, size)
  },
  hideOnSinglePage: true
})
const getVuls = (page = 1, size = 10) => {
  const params = {
    ...data.search,
    page,
    size
  }
  GetAllVul(params)
    .then((res) => {
      // console.log('GetAllVul', res)
      if (res.code !== 200) {
        message.error(res.message)
        return
      }
      data.datasource = res.data.content
      pagination.total = res.data.totalElements
      pagination.current = page
    })
    .catch((err) => {
      console.error(err)
    })
}
const showInfo = (record) => {
  drawer.value.open(record)
}
</script>

<style scoped>
.main {
  position: relative;
  height: 100%;
}
.title {
  font-weight: bold;
  font-size: 24px;
  margin-bottom: 15px;
}
.content_card {
  position: absolute;
  width: 100%;
  height: calc(100% - 32px);
  overflow-y: scroll;
}
.operations {
  display: flex;
  justify-content: right;
  margin-bottom: 20px;
}
.column_name {
  cursor: pointer;
}
.column_name:hover {
  color: #6f005f;
}
.action_icon {
  margin-right: 10px;
}
.cancel_btn:hover {
  border-color: #6f005f;
  color: #6f005f;
}
</style>
<style scoped src="@/atdv/primary-btn.css"></style>
<style scoped src="@/atdv/delete-btn.css"></style>
<style scoped src="@/atdv/input.css"></style>
<style scoped src="@/atdv/input-search.css"></style>
<style scoped src="@/atdv/delete-btn.css"></style>
<style scoped src="@/atdv/pagination.css"></style>
<style scoped src="@/atdv/radio-btn.css"></style>
<style scoped src="@/atdv/select.css"></style>
<style scoped src="@/atdv/spin.css"></style>
